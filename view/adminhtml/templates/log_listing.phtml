<?php
/**
 * MageOS
 *
 * @category   MageOS
 * @package    MageOS_AdminActivityLog
 * @copyright  Copyright (C) 2018 Kiwi Commerce Ltd (https://kiwicommerce.co.uk/)
 * @copyright  Copyright (C) 2025 MageOS (https://mage-os.org/)
 * @license    https://opensource.org/licenses/osl-3.0.php Open Software License (OSL 3.0)
 */

/** @var Escaper $escaper */

/** @var ActivityLogListing $block */

use Magento\Framework\Escaper;
use MageOS\AdminActivityLog\Block\Adminhtml\ActivityLogListing;

$collection = $block->getLogListing();
$adminDetails = $block->getAdminDetails();
$changeCount = is_countable($collection) ? count($collection) : 0;
?>
<div class="activity-log-modal">
    <div class="admin__page-section">
        <div class="admin__page-section-title">
            <span class="title"><?= $escaper->escapeHtml(__('Activity Details')) ?></span>
        </div>
        <?php if (!empty($adminDetails)): ?>
            <div class="admin__page-section-content">
                <div class="admin-details-grid">
                    <div class="admin__field">
                        <span class="admin__field-label"><?= $escaper->escapeHtml(__('Admin User')) ?></span>
                        <span class="admin__field-value">
                            <?php if (!empty($adminDetails['username'])): ?>
                                <?= $escaper->escapeHtml($adminDetails['username']) ?>
                                <?php if (!empty($adminDetails['name'])): ?>
                                    <span class="admin-name">(<?= $escaper->escapeHtml(ucwords(strtolower($adminDetails['name']))) ?>)</span>
                                <?php endif; ?>
                            <?php else: ?>
                                <span class="empty-value"><?= $escaper->escapeHtml(__('Unknown')) ?></span>
                            <?php endif; ?>
                        </span>
                    </div>

                    <div class="admin__field">
                        <span class="admin__field-label"><?= $escaper->escapeHtml(__('Date')) ?></span>
                        <span class="admin__field-value"><?= $escaper->escapeHtml($adminDetails['date']) ?></span>
                    </div>

                    <div class="admin__field">
                        <span class="admin__field-label"><?= $escaper->escapeHtml(__('Module')) ?></span>
                        <span class="admin__field-value"><?= $escaper->escapeHtml($adminDetails['module']) ?></span>
                    </div>

                    <div class="admin__field">
                        <span class="admin__field-label"><?= $escaper->escapeHtml(__('Action')) ?></span>
                        <span class="admin__field-value"><?= $escaper->escapeHtml($adminDetails['fullaction']) ?></span>
                    </div>

                    <div class="admin__field">
                        <span class="admin__field-label"><?= $escaper->escapeHtml(__('Scope')) ?></span>
                        <span class="admin__field-value"><?= $escaper->escapeHtml($adminDetails['scope']) ?></span>
                    </div>

                    <div class="admin__field">
                        <span class="admin__field-label"><?= $escaper->escapeHtml(__('Store')) ?></span>
                        <span class="admin__field-value"><?= $escaper->escapeHtml($adminDetails['store_name']) ?></span>
                    </div>

                    <div class="admin__field full-width">
                        <span class="admin__field-label"><?= $escaper->escapeHtml(__('Path')) ?></span>
                        <span class="admin__field-value"><?= $escaper->escapeHtml($adminDetails['path']) ?></span>
                    </div>

                    <div class="admin__field full-width">
                        <span class="admin__field-label"><?= $escaper->escapeHtml(__('User Agent')) ?></span>
                        <span class="admin__field-value user-agent"><?= $escaper->escapeHtml($adminDetails['browser']) ?></span>
                    </div>
                </div>
            </div>
        <?php endif; ?>
    </div>

    <?php if (!empty($collection)): ?>
        <div class="admin__page-section">
            <div class="admin__page-section-title">
                <span class="title">
                    <?= $escaper->escapeHtml(__('Field Changes')) ?>
                    <span class="changes-count">(<?= $escaper->escapeHtml($changeCount) ?>)</span>
                </span>
            </div>
            <div class="admin__page-section-content">
                <table class="admin__table-secondary">
                    <thead>
                        <tr>
                            <th class="col-field-name"><?= $escaper->escapeHtml(__('Field Name')) ?></th>
                            <th class="col-old-value"><?= $escaper->escapeHtml(__('Old Value')) ?></th>
                            <th class="col-new-value"><?= $escaper->escapeHtml(__('New Value')) ?></th>
                        </tr>
                    </thead>
                    <tbody>
                    <?php
                    foreach ($collection as $item): ?>
                        <?php $isProtected = $block->getProtectedFieldChecker()->isFieldProtected($item['field_name']); ?>
                        <tr>
                            <td class="col-field-name">
                                <?= $escaper->escapeHtml(ucfirst(str_replace('_', ' ', $item['field_name']))) ?>
                            </td>
                            <td class="col-old-value">
                                <?php if ($isProtected): ?>
                                    <span class="protected-value"><?= $escaper->escapeHtml(__('Protected')) ?></span>
                                <?php elseif (trim((string)$item['old_value']) === ''): ?>
                                    <span class="empty-value"><?= $escaper->escapeHtml(__('(empty)')) ?></span>
                                <?php else: ?>
                                    <textarea class="value-container" readonly><?= $escaper->escapeHtml($item['old_value']) ?></textarea>
                                <?php endif; ?>
                            </td>
                            <td class="col-new-value">
                                <?php if ($isProtected): ?>
                                    <span class="protected-value"><?= $escaper->escapeHtml(__('Protected')) ?></span>
                                <?php elseif (trim((string)$item['new_value']) === ''): ?>
                                    <span class="empty-value"><?= $escaper->escapeHtml(__('(empty)')) ?></span>
                                <?php else: ?>
                                    <textarea class="value-container" readonly><?= $escaper->escapeHtml($item['new_value']) ?></textarea>
                                <?php endif; ?>
                            </td>
                        </tr>
                    <?php endforeach; ?>
                    </tbody>
                </table>
            </div>
        </div>
    <?php else: ?>
        <div class="no-changes-message">
            <p><?= $escaper->escapeHtml(__('No field changes recorded for this activity.')) ?></p>
        </div>
    <?php endif; ?>
</div>
