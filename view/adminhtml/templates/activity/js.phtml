<?php
/**
 * MageOS
 *
 * @category   MageOS
 * @package    MageOS_AdminActivityLog
 * @copyright  Copyright (C) 2018 Kiwi Commerce Ltd (https://kiwicommerce.co.uk/)
 * @copyright  Copyright (C) 2025 MageOS (https://mage-os.org/)
 * @license    https://opensource.org/licenses/osl-3.0.php Open Software License (OSL 3.0)
 */

use Magento\Framework\Escaper;
use Magento\Framework\View\Helper\SecureHtmlRenderer;
use MageOS\AdminActivityLog\Block\Adminhtml\Selector;

/** @var Selector $block */
/** @var SecureHtmlRenderer $secureRenderer */
/** @var Escaper $escaper */

$script = <<<JS
    require([
        'jquery',
        'Magento_Ui/js/modal/modal',
        'mage/backend/notification'
    ], function (jQuery, modal, notification) {
        window.keepMultiModalWindow = true;
        const adminActivityLogView = {
            overlayShowEffectOptions: null,
            overlayHideEffectOptions: null,
            modal: null,
            activityId: 0,
            open: function (editorUrl, elementId, revertable) {
                if (editorUrl && elementId) {
                    jQuery.ajax({
                        url: editorUrl,
                        data: {
                            id: elementId
                        },
                        showLoader: true,
                        dataType: 'html',
                        success: (data) => {
                            this.openDialogWindow(data, elementId, revertable);
                        },
                        error: (xhr, status, error) => {
                            this.error('Failed to load activity log: ' + error);
                        }
                    });
                }
            },
            openDialogWindow: function (data, elementId, revertable) {
                let self = this;
                this.activityId = elementId;
                if (this.modal) {
                    this.modal.html(jQuery(data).html());
                } else {
                    this.modal = jQuery(data).modal({
                        title: jQuery.mage.__('Activity Log'),
                        modalClass: 'magento',
                        type: 'slide',
                        firedElementId: elementId,
                        buttons: [{
                            text: jQuery.mage.__('Back'),
                            class: 'action- scalable back',
                            click: function() {
                                self.closeDialogWindow(this);
                            }
                        }, {
                            text: jQuery.mage.__('Revert'),
                            class: 'action- scalable action-primary action-revert-activity',
                            click: function() {
                                self.revertDialogWindow(this);
                            }
                        }],
                        close: function() {
                            self.closeDialogWindow(this);
                        }
                    });
                }
                if (!!revertable) {
                    jQuery(".action-revert-activity").show();
                } else {
                    jQuery(".action-revert-activity").hide();
                }
                this.modal.modal('openModal');
                this.autoResize();
            },
            revertDialogWindow: function (dialogWindow) {
                jQuery.ajax({
                    type: 'POST',
                    url: '{$escaper->escapeUrl($block->getRevertUrl())}',
                    data: {
                        id: this.activityId,
                        form_key: '{$escaper->escapeJs($block->getFormKey())}'
                    },
                    dataType: 'json',
                    showLoader: true,
                    success: (data) => {
                        if (!data.error) {
                            this.closeDialogWindow(dialogWindow);
                            window.location.reload();
                        } else {
                            this.error(data.message);
                        }
                    },
                    error: (xhr, status, error) => {
                        this.error('Failed to revert activity: ' + error);
                    }
                });
            },
            closeDialogWindow: function (dialogWindow) {
                jQuery('body').trigger('processStop');
                dialogWindow.closeModal();
                window.overlayShowEffectOptions = this.overlayShowEffectOptions;
                window.overlayHideEffectOptions = this.overlayHideEffectOptions;
            },
            error: function (message) {
                jQuery('body').notification('clear')
                    .notification('add', {
                        error: true,
                        message: jQuery.mage.__(message),
                        insertMethod: function (message) {
                            let wrapper = jQuery('<div/>').html(message);
                            jQuery('.page-main-actions').after(wrapper);
                        }
                    });
            },
            autoResize: function () {
                jQuery.each(jQuery('textarea.value-container'), function () {
                    let offset = this.offsetHeight - this.clientHeight;
                    const resizeTextarea = function (el) {
                        jQuery(el).css('height', 'auto').css('height', el.scrollHeight + offset);
                    };
                    jQuery(this).off('click').on('click', function () {
                        resizeTextarea(this);
                    }).trigger('click');
                });
            }
        };

        // Export to window for backward compatibility with UI component onclick handlers
        window.adminActivityLogView = adminActivityLogView;
    });
JS;
echo $secureRenderer->renderTag('script', [], $script, false);
